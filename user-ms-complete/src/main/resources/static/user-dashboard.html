<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>User Dashboard â€” Play Store</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root{ --accent:#1466ff; --muted:#556; --card-radius:14px; }
  html,body{ height:100%; margin:0; font-family:Inter,Arial; background: linear-gradient(120deg,#e7fff4,#f0fff8); background-size:400% 400%; animation: gradientMove 14s ease infinite; }
  @keyframes gradientMove{ 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }

  .wrap{ max-width:1100px; margin:24px auto; padding:18px; }
  header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  header h1{ margin:0; color:#064c3b; display:flex; align-items:center; gap:12px; }

  .bell{
    width:22px;
    height:22px;
    cursor:pointer;
    filter:brightness(0.2);
    transition:0.2s;
  }
  .bell:hover{ transform:scale(1.1); }

  .controls{ display:flex; gap:10px; }
  .search{ padding:8px 10px; border-radius:10px; border:1px solid rgba(10,30,60,0.06); }

  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:16px; margin-top:12px;}

  .card{
    border-radius:16px; padding:16px; display:flex; gap:14px; align-items:flex-start;
    background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.86));
    box-shadow: 0 12px 36px rgba(8,28,64,0.06); transition: transform .28s, box-shadow .28s;
  }
  .card:hover{ transform: translateY(-8px); box-shadow: 0 22px 58px rgba(8,28,64,0.08); }

  .icon{ width:86px; height:86px; border-radius:16px; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg,#f6fff9,#f0fff6); overflow:hidden; flex-shrink:0; border:1px solid rgba(10,30,60,0.04);}
  .icon img{ width:100%; height:100%; object-fit:cover; display:block; border-radius:12px; }

  .content{ flex:1; }
  .title{ margin:0; font-size:18px; color:#042a56; }
  .desc{ margin:6px 0 0; color:var(--muted); font-size:13px; }

  .meta{ display:flex; gap:12px; align-items:center; margin-top:10px; flex-wrap:wrap; }
  .chip{ background:#f0fff6; color:#0b7b4a; padding:6px 8px; border-radius:999px; font-size:12px; }

  .actions{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
  .btn{ padding:8px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
  .install{ background:linear-gradient(90deg,#00c2ff,#1466ff); color:white; }
  .outline{ background:transparent; border:1px solid rgba(10,30,60,0.06); }

  .small-muted{ color:#6b7a7a; font-size:13px; }

  /* Notification Box */
  #notif-box{
    position:fixed;
    top:20px;
    right:20px;
    width:260px;
    background:white;
    padding:14px;
    border-radius:12px;
    box-shadow:0 10px 34px rgba(0,0,0,0.15);
    display:none;
  }
  #notif-box h3{ margin:0 0 8px; font-size:15px; }
  #notif-list{ max-height:180px; overflow-y:auto; font-size:13px; }
  .notif-item{ border-bottom:1px solid #eee; padding:6px 0; margin-bottom:6px; }

</style>
</head>

<body>

  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <h1>User Dashboard</h1>

        <!-- ðŸ”” Bell Icon -->
        <img src="https://cdn-icons-png.flaticon.com/512/3602/3602145.png"
             class="bell"
             onclick="toggleNotifications()"/>
      </div>

      <div class="controls">
        <input id="query" class="search" placeholder="Search apps..." />
        <button class="btn outline" onclick="loadVisibleApps()">Refresh</button>
      </div>
    </header>

    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <!-- Notification Panel -->
  <div id="notif-box">
    <h3>Notifications</h3>
    <div id="notif-list"></div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js"></script>

<script>

    const APPS_URL = "http://localhost:8082/apps/visible";
    const SUMMARY_URL = "http://localhost:8081/user/reviews/summary";
    const REVIEWS_URL = "http://localhost:8081/user/reviews";
    const DOWNLOADS_URL = "http://localhost:8081/user/downloads";
    const COUNT_URL = "http://localhost:8081/user/downloads/count";

    const OWNER_NOTIFY_URL = "http://localhost:8082/owner/notify";

    const token = localStorage.getItem('userToken') || '';
    const userId = localStorage.getItem('userId') || 1;

    window.onload = loadVisibleApps;
    document.getElementById('query').addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchApps(); });

    /* ------------------ NOTIFICATIONS ------------------ */

    function toggleNotifications(){
      const box = document.getElementById("notif-box");
      box.style.display = box.style.display === "block" ? "none" : "block";
    }

    function pushNotification(text){
      const list = document.getElementById("notif-list");
      const item = document.createElement("div");
      item.className = "notif-item";
      item.innerText = text;
      list.prepend(item);
    }

    function notifyOwner(appId, type, message){
      fetch(OWNER_NOTIFY_URL, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+token
        },
        body:JSON.stringify({ appId, userId, type, message })
      }).catch(err=>console.error("Notification failed:", err));
    }

    /* ------------------ LOAD APPS ------------------ */

    function loadVisibleApps(){
      fetch(APPS_URL)
        .then(r => r.json())
        .then(list => render(list))
        .catch(e => document.getElementById('grid').innerHTML = '<p>Unable to load apps.</p>');
    }

    function searchApps(){
      const q = (document.getElementById('query').value||'').trim().toLowerCase();
      fetch(APPS_URL)
        .then(r => r.json())
        .then(list => render(list.filter(a =>
          a.name.toLowerCase().includes(q) ||
          (a.genre||"").toLowerCase().includes(q) ||
          (a.description||"").toLowerCase().includes(q)
        )));
    }

    /* ------------------ RENDER CARDS ------------------ */

    function render(list){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      list.forEach(app => {
        const card = document.createElement('div');
        card.className='card';
        card.setAttribute('data-tilt','');

        const iconHtml = app.iconUrl
          ? `<div class="icon"><img src="${escapeHtml(app.iconUrl)}"></div>`
          : `<div class="icon">${initials(app.name)}</div>`;

        card.innerHTML = `
          ${iconHtml}
          <div class="content">
            <div style="display:flex;justify-content:space-between;">
              <div>
                <h3 class="title">${escapeHtml(app.name)}</h3>
                <div class="desc">${escapeHtml(app.description)}</div>
              </div>
              <div style="text-align:right;">
                <div id="rating-${app.appId}" class="small-muted">(loading)</div>
                <div id="downloads-${app.appId}" class="small-muted">â€” downloads</div>
              </div>
            </div>

            <div class="meta">
              ${(app.genre||'').split(',').map(g=>`<div class="chip">${escapeHtml(g)}</div>`).join('')}
            </div>

            <div class="actions">
              <button class="btn install" onclick="downloadApp(${app.appId})">Install</button>
              <button class="btn outline" onclick="openReviewPrompt(${app.appId})">Review</button>
              <button class="btn outline" onclick="toggleReviews(${app.appId}, this)">Show Reviews</button>
            </div>

            <div id="review-panel-${app.appId}" style="display:none;margin-top:10px;background:#fffafa;padding:10px;border-radius:10px;"></div>
          </div>
        `;

        grid.appendChild(card);

        VanillaTilt.init(card, { max:10, speed:400, glare:true, "max-glare":0.08 });

        fetchRatingSummary(app.appId);
        fetchDownloadCount(app.appId);
      });
    }

    /* ------------------ API HELPERS ------------------ */

    function fetchRatingSummary(appId){
      fetch(`${SUMMARY_URL}/${appId}`)
        .then(r=>r.json())
        .then(s=>{
          document.getElementById(`rating-${appId}`).innerText =
            `${Number(s.average||0).toFixed(1)} â€¢ ${s.count||0} reviews`;
        });
    }

    function fetchDownloadCount(appId){
      fetch(`${COUNT_URL}/${appId}`)
        .then(r=>r.text())
        .then(t=>{
          document.getElementById(`downloads-${appId}`).innerText = `${t} downloads`;
        });
    }

    /* ------------------ INSTALL ------------------ */

    function downloadApp(appId){
      fetch(DOWNLOADS_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json","Authorization":"Bearer "+token },
        body:JSON.stringify({ appId, userId })
      })
      .then(r=>r.json())
      .then(()=>{

        pushNotification("App installed successfully!");
        notifyOwner(appId,"DOWNLOAD",`User ${userId} installed app ${appId}`);

        fetchDownloadCount(appId);
      })
      .catch(()=> alert("Failed to install"));
    }

    /* ------------------ REVIEW ------------------ */

    function openReviewPrompt(appId){
      const comment = prompt("Enter your review:");
      if(!comment) return;

      const rating = prompt("Rate 1-5:");
      if(!rating) return;

      fetch(REVIEWS_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json","Authorization":"Bearer "+token },
        body:JSON.stringify({ appId, userId, comment, rating:Number(rating) })
      })
      .then(()=>{

        pushNotification("Review submitted!");
        notifyOwner(appId,"REVIEW",`User ${userId} reviewed app ${appId}`);

        fetchRatingSummary(appId);
      })
      .catch(()=> alert("Failed to submit review"));
    }

    /* ------------------ REVIEWS ------------------ */

    function toggleReviews(appId,btn){
      const panel = document.getElementById(`review-panel-${appId}`);
      if(panel.style.display==="block"){
        panel.style.display="none"; btn.innerText="Show Reviews"; return;
      }
      panel.style.display="block";
      panel.innerHTML="<div class='small-muted'>Loading...</div>";

      fetch(`${REVIEWS_URL}/${appId}`)
        .then(r=>r.json())
        .then(list=>{
          if(!list.length){ panel.innerHTML="<div>No reviews yet.</div>"; btn.innerText="Hide Reviews"; return; }
          panel.innerHTML = list.map(rv =>
            `<div style="padding:8px 0;">
              <b>${rv.rating}/5</b> <span class="small-muted">by user ${rv.userId}</span>
              <div>${escapeHtml(rv.comment)}</div>
            </div>`
          ).join('');
          btn.innerText="Hide Reviews";
        });
    }

    /* ------------------ HELPERS ------------------ */

    function initials(t){ if(!t) return "A"; const p=t.split(" "); return p.length===1?t.slice(0,2).toUpperCase(): (p[0][0]+p[1][0]).toUpperCase(); }
    function escapeHtml(s){ return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

</script>

</body>
</html>
